'From Squeak4.1 of 17 April 2010 [latest update: #9957] on 29 July 2010 at 2:10:17 pm'!!QSharePointRepository methodsFor: 'frontpage rpc' stamp: 'ar 7/20/2010 13:45'!listServerDocuments: url	"List documents from server"	| response stream docs fileInfo fileName fieldStart fieldValue fileSize modifiedBy fileAuthor lastModified fieldEnd |	response := self sendRequest: url,'/_vti_bin/_vti_aut/author.dll' method: {		 'method' -> ('list documents:', self extension).		'service_name' -> ''.		'listHiddenDocs' -> 'false'.		'listExplorerDocs' -> 'false'."		'platform' -> ''.	"		'listRecurse' -> 'true'.		'listFiles' -> 'true'.		'listFolders' -> 'false'.		'listLinkInfo' -> 'false'.		'listIncludeParent' -> 'false'.		'listDerived' -> 'false'.		'listBorders' -> 'false'."		'validateWelcomeNames' -> 'true'.		'folderList' -> ''.	"		'listChildWebs' -> 'false'.		'initialURL' -> ''.	}.	"Extract the documents from the response"	stream := response content readStream.	docs := OrderedCollection new.	stream upToAll: 'document_name='.	[stream atEnd] whileFalse:[		fileInfo := [stream upToAll: 'document_name='] 					on: ConnectionClosed 					do:[:ex| ex return: stream upToEnd].		fileName := (fileInfo copyUpTo: $<) withBlanksTrimmed.		fileName first = $= ifTrue:[fileName := fileName allButFirst withBlanksTrimmed].		fieldStart := fileInfo findString: 'vti_author'.		fieldStart > 0 ifTrue:[			fieldStart := fileInfo findString: '>' startingAt: fieldStart.			fieldEnd := fileInfo findString: '<' startingAt: fieldStart.			fieldValue := (fileInfo copyFrom: fieldStart+1 to: fieldEnd-1) withBlanksTrimmed.			fileAuthor := fieldValue copyAfter: $|.		].		fieldStart := fileInfo findString: 'vti_filesize'.		fieldStart > 0 ifTrue:[			fieldStart := fileInfo findString: '>' startingAt: fieldStart.			fieldEnd := fileInfo findString: '<' startingAt: fieldStart.			fieldValue := (fileInfo copyFrom: fieldStart+1 to: fieldEnd-1) withBlanksTrimmed.			fileSize := (fieldValue copyAfter: $|) asNumber.		].		fieldStart := fileInfo findString: 'vti_modifiedby'.		fieldStart > 0 ifTrue:[			fieldStart := fileInfo findString: '>' startingAt: fieldStart.			fieldEnd := fileInfo findString: '<' startingAt: fieldStart.			fieldValue := (fileInfo copyFrom: fieldStart+1 to: fieldEnd-1) withBlanksTrimmed.			modifiedBy := fieldValue copyAfter: $|.		].		fieldStart := fileInfo findString: 'vti_timelastmodified '.		fieldStart > 0 ifTrue:[			fieldStart := fileInfo findString: '>' startingAt: fieldStart.			fieldEnd := fileInfo findString: '<' startingAt: fieldStart.			fieldValue := (fileInfo copyFrom: fieldStart+1 to: fieldEnd-1) withBlanksTrimmed.			lastModified := fieldValue copyAfter: $|.		].		"We really only want the user documents which have a ContentTypeId in SP 2008.		However, SP2003 does not include this property so instead we only suppress all the		Microsoft files that end in .aspx"		"fieldStart := fileInfo findString: 'ContentTypeId'.		fieldStart > 0 ifTrue:[]."		(fileName asLowercase endsWith: '.aspx') ifFalse:[			docs add: {				fileName. 				fileSize ifNil:[0]. 				fileAuthor ifNil:['unknown']. 				lastModified ifNil:['unknown']. 				modifiedBy ifNil:['unknown'].			}.		].	].	^docs! !