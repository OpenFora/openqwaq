'From Croquet1.0beta of 11 April 2006 [latest update: #1] on 12 March 2010 at 3:10:43 pm'!!QServiceManagerV2 methodsFor: 'requests' stamp: 'jcg 3/12/2010 15:03'!connectPostVersion2	"Connect to the service provider, authenticate and redirect if necessary.	This is the version since Qwaq Forums 2.0."	| socket reply writer |	self disconnect. "close persistent connection gracefully"	socket := hostInfo connect.	socket waitForConnectionFor: 5.	CWin32Platform isActivePlatform ifTrue: [		"Unnecessary on OS X, which seems to dynamically tune buffer size."		"The SO_RCVBUF value doesn't affect the max upload speed,		 but it seems that if it's too small (compared to SO_SNDBUF?),		 there's a chance of a dropped socket."		"http://msdn.microsoft.com/en-us/library/ms819736.aspx"		"http://msdn.microsoft.com/en-us/library/ms740476(VS.85).aspx"		socket setOption: 'SO_RCVBUF' value: 64240.		socket setOption: 'SO_SNDBUF' value: 64240.	].	socket sendData: self class messageID.	socketStream := SocketStream on: socket.	writer := XMLWriter on: socketStream.	writer startTag: 'connect2'.		"Note: This data really should not be here since the connection is not encrypted		yet and it is conceivable that revealing user and org name is a security issue.		Unfortunately, the 2.0.10 server release (which is currently in production) does not		support the alternative of using the info from authenticate. Once this is fixed we need		to remove the info here and only provide it in authenticate."		writer attribute: 'user' value: user.		writer attribute: 'realm' value: self realm.		writer attribute: 'orgName' value: (self orgName).		writer attribute: 'version' value: version.		writer attribute: 'client' value: clientVersion.	writer endEmptyTag: 'connect2'.	socketStream flush.	"pump out the request"	TTrafficCounter current sent: (socket totalBytesSent) tag: self trafficTag.	socket resetTotals.	"Wait for reply"	reply := (XMLDOMParser on: socketStream) nextEntity.	reply name == #ok ifFalse:[		"clean up or else reconnect gets confused"		socket destroy.		socketStream := nil.		^reply].	sendLoop := self forkSuspended: #sendRequestLoop at: Processor lowIOPriority.	recvLoop := self forkSuspended: #recvRequestLoop at: Processor lowIOPriority.	"Encrypt the connection"	self encryptConnection: socketStream key: (reply contentStringAt: 'rsakey').	"Once encrypted, let the worker processes do their thing"	sendLoop resume.	recvLoop resume.	^self authenticatePostVersion2. "find out if we are admin"! !!TMessageRelay methodsFor: 'connecting' stamp: 'jcg 3/12/2010 15:03'!connect	"Connect to the router"	[socket := hostInfo connect.	socket waitForConnectionFor: 5] on: Error do:[:ex|		"We may get destroyed during the connection wait,	 	 if something goes weirdly wrong during a high-level island setup."		socket ifNotNilDo: [:s | s destroy].		socket := nil.		ex return.	].	socket ifNil:[^false].	socket isConnected ifFalse:[		socket destroy.		socket := nil.		^false].	"Disable TCP delays"	socket setOption: 'TCP_NODELAY' value: true.	CWin32Platform isActivePlatform ifTrue: [		"Unnecessary on OS X, which seems to dynamically tune buffer size."		"The SO_RCVBUF value doesn't affect the max upload speed,		 but it seems that if it's too small (compared to SO_SNDBUF?),		 there's a chance of a dropped socket."		"http://msdn.microsoft.com/en-us/library/ms819736.aspx"		"http://msdn.microsoft.com/en-us/library/ms740476(VS.85).aspx"		socket setOption: 'SO_RCVBUF' value: 35040.		socket setOption: 'SO_SNDBUF' value: 35040.	].	self startUp.	^true! !